name: Review Changes

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  lint-commits:
    name: Lint Commit Message Format
    if: ${{ github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ— Install canvas deps
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libcairo2-dev libgif-dev libjpeg-dev libpango1.0-dev librsvg2-dev
          version: canvas-deps-1

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main

      - name: ğŸ” Lint all commit messages
        run: |
          pnpm -s run lint:commits \
            --from ${{ github.event.pull_request.head.sha }}~${{ github.event.pull_request.commits }} \
            --to ${{ github.event.pull_request.head.sha }}

  lint-deps:
    name: Lint Dependencies, Files and Exports
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ— Install canvas deps
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libcairo2-dev libgif-dev libjpeg-dev libpango1.0-dev librsvg2-dev
          version: canvas-deps-1

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main

      - name: ğŸ” Find unused files, dependencies and exports
        run: pnpm -s run lint:deps --reporter github-actions

  lint-markdown:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ— Install canvas deps
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libcairo2-dev libgif-dev libjpeg-dev libpango1.0-dev librsvg2-dev
          version: canvas-deps-1

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main

      - name: ğŸ” Lint all Markdown files
        run: pnpm -s run lint:markdown

  lint-style:
    name: Lint File Format
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main

      - name: ğŸ” Check if the files are formatted
        run: pnpm -s run lint:style

  lint-versions:
    name: Lint Consistency of Versions and Ranges
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ— Install canvas deps
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libcairo2-dev libgif-dev libjpeg-dev libpango1.0-dev librsvg2-dev
          version: canvas-deps-1

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main

      - name: ğŸ” Lint all versions and ranges
        run: pnpm -s run lint:versions

  lint-yaml:
    name: Lint YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ— Install yamllint
        run: pip install yamllint

      - name: ğŸ” Lint all YAML files
        run: yamllint --format github .

  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ— Install canvas deps
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libcairo2-dev libgif-dev libjpeg-dev libpango1.0-dev librsvg2-dev
          version: canvas-deps-1

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          turbo-s3-endpoint: nbg1.your-objectstorage.com
          turbo-s3-region: nbg1
          turbo-s3-bucket: turbo-bucket-1
          turbo-s3-access-key: ${{ secrets.TURBO_S3_ACCESS_KEY }}
          turbo-s3-secret-key: ${{ secrets.TURBO_S3_SECRET_KEY }}
          turbo-token: ${{ secrets.TURBO_TOKEN }}

      - name: ğŸ” Lint source code affected by changes
        run: pnpm -s run lint --affected

      - name: ğŸ”¨ Run build of projects affected by changes
        run: pnpm -s run build --affected
